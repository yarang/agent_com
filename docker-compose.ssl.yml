# SSL configuration for production
# Usage: docker-compose -f docker-compose.yml -f docker-compose.ssl.yml --profile ssl up

services:
  # Certbot for Let's Encrypt certificate management
  certbot:
    image: certbot/certbot:latest
    container_name: agent-comm-certbot
    volumes:
      - ./certificates:/etc/letsencrypt/live/${DOMAIN}
      - ./certbot-webroot:/var/www/html
    entrypoint: >
      sh -c "
        if [ ! -f /etc/letsencrypt/live/${DOMAIN}/cert.pem ]; then
          echo 'Obtaining certificate...'
          certonly --webroot
          --webroot-path=/var/www/html
          --email ${EMAIL}
          --agree-tos
          --no-eff-email
          -d ${DOMAIN}
          ${STAGING:---staging}
        else
          echo 'Certificate exists. Renewing...'
          renew --quiet
        fi
        && cp /etc/letsencrypt/live/${DOMAIN}/fullchain.pem /etc/letsencrypt/live/${DOMAIN}/cert.pem
        && cp /etc/letsencrypt/live/${DOMAIN}/privkey.pem /etc/letsencrypt/live/${DOMAIN}/key.pem
      "
    networks:
      - agent-comm-network
    profiles:
      - ssl

  # Nginx reverse proxy with SSL termination
  nginx:
    image: nginx:alpine
    container_name: agent-comm-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certificates:/etc/letsencrypt/live/${DOMAIN}:ro
      - ./certbot-webroot:/var/www/html:ro
    depends_on:
      - communication-server
    networks:
      - agent-comm-network
    profiles:
      - ssl

networks:
  agent-comm-network:
    external: true

volumes:
  certbot-webroot:
